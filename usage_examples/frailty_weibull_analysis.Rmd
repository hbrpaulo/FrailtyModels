---
title: "Frailty Model Analysis via Modular Functions"
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
source("../scripts/R/legacy/analysis/baseline_weibull.R")
source("../scripts/R/legacy/analysis/simulate_frailty.R")
source("../scripts/R/legacy/analysis/estimate_frailty_mle.R")
source("../scripts/R/legacy/analysis/coverage_study.R")
source("../scripts/R/legacy/analysis/funnel_plot.R")
source("../scripts/R/legacy/analysis/wrapper_pipeline.R")
```

## 1. Simulate Weibull Survival Times

```{r simulate}
set.seed(2025)
sim_data <- simulate_frailty(n = 200, shape = 1.4, scale = 1, theta = 0.6)
head(sim_data)
```

## 2. Estimate Frailty Model Parameters

```{r estimate}
fit <- estimate_frailty_mle(sim_data)
fit
```

## 3. Coverage Study Across Sample Sizes

```{r coverage}
cover_res <- coverage_study_multi(sample_sizes = c(50, 100, 200),
                                  shape = 1.4, scale = 1, theta = 0.6,
                                  nsim = 30)
cover_res
```

## 4. Visualize Confidence Interval Widths

```{r funnel_plot, fig.width=6, fig.height=4}
funnel_plot(cover_res)
```

## 5. End-to-End Pipeline

```{r pipeline}
pipe <- frailty_simulation_pipeline_weibull(shape = 1.4, scale = 1,
                                            theta = 0.6, nsim = 30,
                                            sample_sizes = c(100, 200, 400))
str(pipe, max.level = 1)
```

