---
title: "Gamma Frailty Model with Gompertz Baseline"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
    theme: united
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(survival)
library(tidyverse)
library(kableExtra)
```

## 1. Simulation

```{r}
set.seed(2025)

n <- 5000
a_base <- rexp(1, 1)
b_base <- rexp(1, 1)
frailty_variance <- rgamma(1, shape = 2, rate = 2)
beta_a <- rnorm(2)
beta_b <- rnorm(2)

cov_df <- tibble(
  X1 = rbinom(n, 1, 0.5),
  X2 = rnorm(n)
)

alpha_gamma_sim <- 1 / frailty_variance
Z <- rgamma(n, shape = alpha_gamma_sim, rate = alpha_gamma_sim)

X <- as.matrix(cov_df)
a_ind <- exp(log(a_base) + X %*% beta_a)
b_ind <- exp(log(b_base) + X %*% beta_b)

U <- runif(n)
times <- (1 / b_ind) * log(1 - (b_ind / (a_ind * Z)) * log(U))

cens_times <- rexp(n, rate = 0.05)
observed_times <- pmin(times, cens_times)
event <- as.numeric(times <= cens_times)
```

## 2. Log-Likelihood

```{r}
gompertz_frailty_cov_loglik <- function(params, times, event, X) {
  a_base <- params[1]; b_base <- params[2]; frailty_var <- params[3]
  p <- ncol(X)
  beta_a <- params[4:(3 + p)]
  beta_b <- params[(4 + p):(3 + 2 * p)]

  if (any(c(a_base, b_base, frailty_var) <= 0)) return(Inf)

  alpha_gamma <- 1 / frailty_var
  a_ind <- exp(log(a_base) + X %*% beta_a)
  b_ind <- exp(log(b_base) + X %*% beta_b)
  H0 <- (a_ind / b_ind) * (exp(b_ind * times) - 1)
  h0 <- a_ind * exp(b_ind * times)
  S <- (1 + H0 / alpha_gamma)^(-alpha_gamma)
  h <- h0 / (1 + H0 / alpha_gamma)

  if (any(S <= 0) || any(event == 1 & h <= 0)) return(Inf)
  -sum(event * (log(h) + log(S)) + (1 - event) * log(S))
}
```

## 3. MLE Estimation

```{r}
alpha <- 0.05
p <- ncol(X)
init_params <- c(0.1, 0.1, 0.3, rep(0, 2 * p))

opt <- optim(init_params, gompertz_frailty_cov_loglik,
             times = observed_times, event = event, X = X,
             method = "L-BFGS-B",
             lower = c(0.001, 0.001, 0.01, rep(-Inf, 2 * p)),
             hessian = TRUE)

est <- opt$par
vcov_mat <- solve(opt$hessian)
se <- sqrt(diag(vcov_mat))
z_val <- qnorm(1 - alpha / 2)

param_names <- c("a Base", "b Base", "Frailty Variance",
                 paste0("Beta_a", 1:p), paste0("Beta_b", 1:p))
true_values <- c(a_base, b_base, frailty_variance, beta_a, beta_b)

ci <- data.frame(
  Parameter = param_names,
  Lower = est - z_val * se,
  `True Values` = true_values,
  Upper = est + z_val * se,
  CI = ifelse(true_values >= (est - z_val * se) &
                true_values <= (est + z_val * se), "Yes", "No"),
  Estimate = est,
  SE = se
)

kbl(ci, align = 'lccccc', digits = 3) %>%
  kableExtra::kable_styling(full_width = FALSE,
                            bootstrap_options = c("striped", "hover", "condensed"))
```

## 4. Empirical Bayes Frailty

```{r}
EB_frailty_gompertz <- function(params, times, event, X) {
  a_base <- params[1]; b_base <- params[2]; frailty_var <- params[3]
  p <- ncol(X)
  beta_a <- params[4:(3 + p)]
  beta_b <- params[(4 + p):(3 + 2 * p)]

  alpha <- 1 / frailty_var
  a_ind <- exp(log(a_base) + X %*% beta_a)
  b_ind <- exp(log(b_base) + X %*% beta_b)
  H0 <- (a_ind / b_ind) * (exp(b_ind * times) - 1)
  (alpha + event) / (alpha + H0)
}

frailty_est <- EB_frailty_gompertz(est, observed_times, event, X)

ggplot(data.frame(frailty = frailty_est), aes(x = frailty)) +
  geom_histogram(aes(y = after_stat(density)), bins = 25,
                 fill = "skyblue", color = "darkblue", alpha = 0.6) +
  geom_density(linetype = "dashed", color = "darkgreen", linewidth = 1.2) +
  labs(title = "Empirical Bayes Frailty Estimates - Gompertz Baseline",
       x = "Frailty (Z)", y = "Density") +
  theme_minimal()
```

## 5. Coverage Probability Study

```{r coverage, eval = TRUE, cache = TRUE}
coverage_study <- function(n_sim = 500, n = 5000, alpha = 0.05) {
  cover_results <- matrix(NA, nrow = n_sim, ncol = length(true_values))
  colnames(cover_results) <- param_names
  ci_records <- list()

  for (sim in 1:n_sim) {
    if (interactive()) cat("Running simulation", sim, "of", n_sim, "\n")

    Z <- rgamma(n, shape = 1 / frailty_variance, rate = 1 / frailty_variance)
    X <- as.matrix(cov_df)
    a_ind <- exp(log(a_base) + X %*% beta_a)
    b_ind <- exp(log(b_base) + X %*% beta_b)
    U <- runif(n)
    times <- (1 / b_ind) * log(1 - (b_ind / (a_ind * Z)) * log(U))
    cens_times <- rexp(n, rate = 0.05)
    obs_times <- pmin(times, cens_times)
    event <- as.numeric(times <= cens_times)

    init_params <- c(0.1, 0.1, 0.3, rep(0, 2 * ncol(X)))
    opt <- tryCatch(
      optim(init_params, gompertz_frailty_cov_loglik,
            times = obs_times, event = event, X = X,
            method = "L-BFGS-B",
            lower = c(0.001, 0.001, 0.01, rep(-Inf, 2 * ncol(X))),
            hessian = TRUE),
      error = function(e) NULL
    )
    if (is.null(opt) || !is.finite(opt$value)) next

    est <- opt$par
    vcov_mat <- tryCatch(solve(opt$hessian), error = function(e) NULL)
    if (is.null(vcov_mat)) next

    se <- sqrt(diag(vcov_mat))
    z_val <- qnorm(1 - alpha / 2)
    lower <- est - z_val * se
    upper <- est + z_val * se

    cover_results[sim, ] <- (true_values >= lower) & (true_values <= upper)

    ci_df <- data.frame(Parameter = param_names,
                        Lower = lower, Estimate = est, Upper = upper,
                        True = true_values, Sim = sim)
    ci_records[[sim]] <- ci_df
  }

  cover_results <- cover_results[complete.cases(cover_results), ]
  coverage <- colMeans(cover_results)
  ci_all <- do.call(rbind, ci_records)
  list(coverage = coverage, ci_data = ci_all)
}

set.seed(123)
coverage <- coverage_study(n_sim = 5)
```

```{r}
print(coverage)
coverage_df <- data.frame(Parameter = names(coverage$coverage),
                          Coverage = round(coverage$coverage, 3))
ggplot(coverage_df, aes(x = Parameter, y = Coverage)) +
  geom_col(fill = "steelblue") +
  geom_hline(yintercept = 0.95, linetype = "dashed", color = "red") +
  ylim(0, 1) +
  labs(title = "Coverage Probability by Parameter",
       y = "Coverage", x = "Parameter") +
  theme_minimal()
```

```{r coverage_multiN, eval = TRUE, cache = TRUE}
coverage_study_multiN <- function(N_values = c(200, 500, 1000, 2000),
                                  n_sim = 200, alpha = 0.05) {
  results_list <- list()
  ci_funnel_list <- list()

  for (N in N_values) {
    if (interactive()) cat("Running simulations for N =", N, "\n")
    cov_res <- coverage_study(n_sim = n_sim, n = N, alpha = alpha)
    coverage <- cov_res$coverage
    ci_data <- cov_res$ci_data
    ci_data$N <- N

    df_cov <- data.frame(Parameter = names(coverage),
                         Coverage = as.numeric(coverage), N = N)
    results_list[[as.character(N)]] <- df_cov
    ci_funnel_list[[as.character(N)]] <- ci_data
  }

  results_df <- do.call(rbind, results_list)
  ci_funnel_df <- do.call(rbind, ci_funnel_list)
  list(coverage_df = results_df, ci_funnel_df = ci_funnel_df)
}

set.seed(123)
N_values <- c(50, 100, 200, 500, 1000)
coverage_multiN <- coverage_study_multiN(N_values = N_values,
                                         n_sim = 10, alpha = 0.05)
```

```{r}
ggplot(coverage_multiN$coverage_df,
       aes(x = N, y = Coverage, color = Parameter, group = Parameter)) +
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  geom_hline(yintercept = 0.95, linetype = "dashed", color = "red") +
  ylim(0, 1) +
  labs(title = "Coverage Probability Across Sample Sizes",
       x = "Sample Size (N)", y = "Coverage") +
  theme_minimal()

ci_funnel_df <- coverage_multiN$ci_funnel_df %>%
  arrange(N) %>%
  group_by(Parameter, N) %>%
  summarise(Lower = mean(Lower), Estimate = mean(Estimate),
            Upper = mean(Upper), True = mean(True), .groups = "drop")

ggplot(ci_funnel_df, aes(x = N)) +
  geom_point(aes(y = Estimate), color = "blue", alpha = 0.3, size = 0.5) +
  geom_errorbar(aes(ymin = Lower, ymax = Upper), alpha = 0.1) +
  geom_hline(aes(yintercept = True), linetype = "dashed", color = "red") +
  facet_wrap(~ Parameter, scales = "free_y") +
  labs(title = "Funnel Plot of Confidence Intervals vs Sample Size",
       y = "Parameter Estimate / CI", x = "Sample Size (N)") +
  scale_x_log10() +
  theme_void()
```

```{r}
beepr::beep(2)
```
